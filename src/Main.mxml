<?xml version="1.0"?>
<s:Application xmlns:fx="http://ns.adobe.com/mxml/2009"
               xmlns:s="library://ns.adobe.com/flex/spark"
               width="100%" height="100%" frameRate="60"
               creationComplete="onCreationComplete(event)">

    <fx:Script>
        <![CDATA[
        import mx.core.UIComponent;
        import mx.events.FlexEvent;

        public static var map:Map;
        private var layer0:UIComponent;
        private var layer1:UIComponent;

        public function onCreationComplete(event:FlexEvent):void {
            layer0 = new UIComponent();
            addElement(layer0);
            layer1 = new UIComponent();
            addElement(layer1);

            createNewMap();

            addEventListener(MouseEvent.RIGHT_CLICK, function (event:MouseEvent):void {
                createNewMap();
            });

            addEventListener(MouseEvent.MOUSE_MOVE, function (event:MouseEvent):void {
                //draw();
                layer1.graphics.clear();

                var p:Point = new Point(event.stageX, event.stageY);
                var size:int = 50;
                var range:Rectangle = new Rectangle(p.x - size / 2, p.y - size / 2, size, size);
                var arr:Array = map.quadTree.query(range);
                for each (p in arr) {
                    layer1.graphics.beginFill(Color.red);
                    layer1.graphics.drawCircle(p.x, p.y, 1);
                    layer1.graphics.endFill();
                }

                layer1.graphics.lineStyle(1, Color.blue);
                layer1.graphics.drawRect(range.x, range.y, range.width, range.height)
            });
        }

        private function createNewMap():void {

            map = new Map(width, height, 100000);

            draw();
        }

        private function draw():void {
            layer0.graphics.clear();
            layer0.graphics.lineStyle();
            var queue:Array = [map.quadTree];
            while (queue.length > 0) {
                var q:QuadTree = queue.pop();
                for each (var t:QuadTree in q.quads)
                    queue.push(t);

                if (q.point) {
                    layer0.graphics.beginFill(Color.black);
                    layer0.graphics.drawCircle(q.point.x, q.point.y, 1);
                    layer0.graphics.endFill();
                }
            }
        }
        ]]>
    </fx:Script>
</s:Application>