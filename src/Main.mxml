<?xml version="1.0"?>
<s:Application xmlns:fx="http://ns.adobe.com/mxml/2009"
               xmlns:s="library://ns.adobe.com/flex/spark"
               width="100%" height="100%" frameRate="60"
               creationComplete="onCreationComplete(event)">

    <fx:Script>
        <![CDATA[
        import Map.Map;
        import Map.QuadTree.QuadTree;

        import mx.core.UIComponent;

        import mx.events.FlexEvent;

        public static var map:Map;
        private var c:UIComponent;
        private var d:UIComponent;

        public function onCreationComplete(event:FlexEvent):void {
            c = new UIComponent();
            addElement(c);
            d = new UIComponent();
            addElement(d);

            createNewMap();

            addEventListener(MouseEvent.RIGHT_CLICK, function (event:MouseEvent):void {
                createNewMap();
            });

            addEventListener(MouseEvent.MOUSE_MOVE, function (event:MouseEvent):void {
                //draw();
                d.graphics.clear();

                var p:Point = new Point(event.stageX, event.stageY);
                var size:int = 10;
                var range:Rectangle = new Rectangle(p.x - size / 2, p.y - size / 2, size, size);
                var arr:Array = map.quadTree.query(range);
                for each (p in arr) {
                    d.graphics.beginFill(Color.red);
                    d.graphics.drawCircle(p.x, p.y, 3);
                    d.graphics.endFill();
                }

                d.graphics.lineStyle(1, Color.blue);
                d.graphics.drawRect(range.x, range.y, range.width, range.height)
            });
        }

        private function createNewMap():void {

            map = new Map(width, height, 25000);

            draw();
        }

        private function draw():void {
            c.graphics.clear();
            var queue:Array = [map.quadTree];
            while (queue.length > 0) {
                var q:QuadTree = queue.pop();
                for each (var t:QuadTree in q.quads)
                    queue.push(t);

                if (q.point) {
                    var color:uint = Color.black;
                    c.graphics.lineStyle(1, color);
                    c.graphics.drawRect(q.bounds.x, q.bounds.y, q.bounds.width, q.bounds.height);

                    c.graphics.lineStyle();
                    c.graphics.beginFill(color);
                    c.graphics.drawCircle(q.point.x, q.point.y, 3);
                    c.graphics.endFill();
                }
            }
        }
        ]]>
    </fx:Script>
</s:Application>